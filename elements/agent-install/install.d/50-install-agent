#!/bin/bash
set -euo pipefail

# Ищем, где лежит наш элемент
# $0 это путь к скрипту внутри tmp/hooks/install.d/..., нам нужно найти исходный agent
# Но DIB копирует элемент целиком. В build-time элементы лежат в TMP_HOOKS_PATH.
# Обычно бинарник, который мы положили в elements/agent-install/agent, будет доступен как:
# $TMP_HOOKS_PATH/../../agent-install/agent (сложно угадать)

# ПРОЩЕ: DIB копирует содержимое element-a в специальную папку.
# Но в нашем Dockerfile мы копируем agent ВНУТРЬ elements/agent-install/agent ПЕРЕД сборкой.

# В DIB переменная $ELEMENTS_PATH указывает на папки с элементами.
# Но скрипт запускается уже внутри chroot.
# Файлы элемента доступны через специальные переменные, но проще всего, если DIB их скопировал.

# В нашем случае мы полагаемся на то, что бинарник лежит рядом со скриптами в исходниках, 
# и DIB скопировал их.
# Обычно для копирования файлов используют element-copy. Но мы делаем cp вручную.
# В DIB есть переменная $IMAGE_ELEMENT_DIR - путь к текущему элементу.

if [ -z "${IMAGE_ELEMENT_DIR:-}" ]; then
  # Fallback если DIB старый
  IMAGE_ELEMENT_DIR=$(dirname $(dirname $0))
fi

echo "Installing Agent binary from $IMAGE_ELEMENT_DIR/agent..."

if [ ! -f "$IMAGE_ELEMENT_DIR/agent" ]; then
    echo "ERROR: Agent binary not found at $IMAGE_ELEMENT_DIR/agent"
    exit 1
fi

cp "$IMAGE_ELEMENT_DIR/agent" "/usr/local/bin/agent"
chmod +x "/usr/local/bin/agent"

echo "Creating Systemd Unit..."
mkdir -p "/etc/systemd/system"

cat <<EOF > "/etc/systemd/system/image-agent.service"
[Unit]
Description=Image Manager Test Agent
After=network-online.target
Wants=network-online.target

[Service]
EnvironmentFile=-/etc/image-manager-agent.env
ExecStart=/usr/local/bin/agent
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

echo "Enabling service..."
ln -sf /etc/systemd/system/image-agent.service \
   "/etc/systemd/system/multi-user.target.wants/image-agent.service"

echo "Agent installed and enabled."