# Архитектура и Логика работы

## Компоненты

1.  **Image Manager (Go):**
    *   Центральный компонент.
    *   Предоставляет HTTP API и Веб-интерфейс.
    *   Запускает процесс сборки (disk-image-builder).
    *   Взаимодействует с OpenStack API (Glance, Nova).
    *   Содержит gRPC сервер для приема отчетов от агентов.

2.  **Disk Image Builder (DIB):**
    *   Утилита OpenStack для сборки образов.
    *   Запускается как дочерний процесс внутри пода Image Manager.
    *   Использует кастомные элементы (`elements/`) для настройки образа.

3.  **Agent (Go):**
    *   Микросервис, который компилируется и "запекается" внутрь образа.
    *   Запускается автоматически при старте VM (systemd).
    *   Выполняет проверки (сеть, диск) и отправляет отчет по gRPC.

4.  **Инфраструктура:**
    *   **Kubernetes (K3s):** Оркестрация.
    *   **Nginx Ingress:** Маршрутизация трафика (Web + gRPC).
    *   **RabbitMQ / Registry / Jenkins:** Вспомогательные сервисы.

## Рабочий процесс (Workflow)

### 1. Инициация сборки
Пользователь нажимает "Собрать" в веб-интерфейсе.
*   Менеджер создает запись в БД (Status: PENDING).
*   Запускается горутина сборки.

### 2. Сборка (Build)
*   Менеджер запускает `disk-image-create` с параметрами из `configs/distros/*.yaml`.
*   В образ внедряется бинарник Агента и конфиг (`/etc/image-manager-agent.env`) с адресом gRPC сервера.
*   Результат: файл `.qcow2` на диске.

### 3. Загрузка (Upload)
*   Образ загружается в OpenStack Glance.
*   **Важно:** Используется имя с суффиксом `-candidate` (например, `Ubuntu-24-candidate`).
*   ID образа сохраняется в БД.

### 4. Тестирование (Test Boot)
*   Менеджер создает тестовую VM в OpenStack из образа-кандидата.
*   Ожидает перехода VM в статус `ACTIVE` (до 5 минут).
*   Переходит в режим ожидания агента (`WAITING_AGENT`).

### 5. Проверка (Agent Report)
*   VM загружается, стартует Агент.
*   Агент проверяет:
    *   Доступность интернета (ping 8.8.8.8).
    *   Размер корневого раздела (disk resize).
*   Агент отправляет gRPC запрос `ReportStatus` на сервер.

### 6. Завершение (Promotion)
Если отчет успешный:
1.  **Promote:** Менеджер удаляет старый "боевой" образ (`Ubuntu-24`) и переименовывает кандидата в `Ubuntu-24`.
2.  **Cleanup:** Тестовая VM удаляется.
3.  **Status:** Сборка помечается `SUCCESS`.

Если отчет с ошибкой или таймаут:
1.  Кандидат не становится боевым.
2.  VM удаляется (или остается для дебага, зависит от настроек).
3.  Status: `ERROR`.
