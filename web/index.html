<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Manager | Center</title>
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --bg-panel: #252526;
            --text-main: #e0e0e0;
            --text-muted: #858585;
            --accent: #007acc;
            --accent-hover: #0062a3;
            --danger: #f44336;
            --success: #4caf50;
            --border: #333;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 250px;
            background-color: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
        }

        .brand {
            padding: 0 20px 20px;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 10px;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            padding: 15px 20px;
            text-align: left;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-btn:hover {
            background-color: #2d2d2d;
            color: var(--text-main);
        }

        .nav-btn.active {
            background-color: #333;
            color: var(--text-main);
            border-left-color: var(--accent);
        }

        /* --- CONTENT --- */
        .content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .page.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 { margin-top: 0; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        h3 { color: var(--text-muted); font-size: 1rem; margin-top: 30px; border-bottom: 1px dashed #444; padding-bottom: 5px; }

        /* --- TABLES --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--bg-panel);
            border-radius: 4px;
            overflow: hidden;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th { background-color: #333; text-transform: uppercase; font-size: 0.85rem; color: var(--text-muted); }
        tr:hover { background-color: #2d2d2d; }
        
        /* Disabled rows */
        tr.disabled-row { opacity: 0.5; }

        /* --- STATUS BADGES --- */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .badge-yes { background-color: rgba(76, 175, 80, 0.2); color: var(--success); }
        .badge-no { background-color: rgba(244, 67, 54, 0.2); color: var(--danger); }
        .badge-unk { background-color: rgba(133, 133, 133, 0.2); color: var(--text-muted); }

        /* --- CONTROLS --- */
        .btn-action {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-action:hover { background-color: var(--accent-hover); }
        .btn-disabled { background-color: #444; color: #888; cursor: not-allowed; }

        input[type="text"] {
            background: #111; border: 1px solid #444; color: #eee; padding: 5px; border-radius: 3px;
        }

        /* --- LOGS & PROGRESS --- */
        .log-container {
            margin-top: 20px;
            background: #111;
            border-radius: 4px;
            padding: 10px;
            display: none; 
        }
        
        .progress-track {
            background: #333;
            height: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.5s ease;
        }

        .log-console {
            color: #0f0;
            font-family: 'Courier New', monospace;
            height: 200px;
            overflow-y: scroll;
            font-size: 0.9rem;
        }
        
        .log-entry { margin-bottom: 4px; }
        
        /* --- STANDS GRID --- */
        .stands-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        .stand-card {
            background: var(--bg-panel);
            padding: 20px;
            border-radius: 4px;
            border: 1px solid var(--border);
            text-align: center;
        }
        .stand-offline { color: #666; font-style: italic; }

        /* --- MODAL --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background-color: #222; margin: 10% auto; padding: 20px; border: 1px solid #444; width: 80%; max-width: 900px;
            border-radius: 5px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #fff; }
        #modal-logs-body {
            background: #111; color: #0f0; padding: 10px; height: 400px; overflow-y: auto; 
            font-family: 'Courier New', monospace; white-space: pre-wrap; font-size: 0.9rem;
        }

    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <nav class="sidebar">
        <div class="brand">IMAGE Manager</div>
        <button class="nav-btn active" onclick="showTab('images')">üì¶ –û–±—Ä–∞–∑—ã</button>
        <button class="nav-btn" onclick="showTab('stands')">‚òÅÔ∏è –°—Ç–µ–Ω–¥—ã</button>
        <button class="nav-btn" onclick="showTab('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    </nav>

    <!-- CONTENT -->
    <main class="content">

        <!-- –í–∫–ª–∞–¥–∫–∞ 1: –û–ë–†–ê–ó–´ -->
        <div id="page-images" class="page active">
            <h2>–£–ü–†–ê–í–õ–ï–ù–ò–ï –û–ë–†–ê–ó–ê–ú–ò</h2>
            <table>
                <thead>
                    <tr>
                        <th>–ò–º—è –æ–±—Ä–∞–∑–∞</th>
                        <th>–ó–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å—Ç–µ–Ω–¥</th>
                        <th>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</th>
                        <th>–ê—Ä–≥—É–º–µ–Ω—Ç—ã —Å–±–æ—Ä–∫–∏ (DIB)</th>
                        <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                        <th>EOL</th>
                    </tr>
                </thead>
                <tbody id="images-table-body">
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
                </tbody>
            </table>

            <!-- –õ–æ–≥–∏ –∏ –ü—Ä–æ–≥—Ä–µ—Å—Å -->
            <div id="log-container" class="log-container">
                <div class="progress-track">
                    <div id="progress-bar" class="progress-bar"></div>
                </div>
                <div id="live-logs" class="log-console">
                    <div class="log-entry" style="color: #666">[SYSTEM] –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.</div>
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ 2: –°–¢–ï–ù–î–´ -->
        <div id="page-stands" class="page">
            <h2>–°–æ—Å—Ç–æ—è–Ω–∏–µ –°—Ç–µ–Ω–¥–æ–≤</h2>
            
            <h3>DevStack (–¢–µ–∫—É—â–∏–π)</h3>
            <p style="color: #888; font-size: 0.9rem;">–°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤ –≤ –æ–±–ª–∞–∫–µ:</p>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ò–º—è –≤ Glance</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                        <th>–†–∞–∑–º–µ—Ä</th>
                    </tr>
                </thead>
                <tbody id="stand-devstack-rows">
                    <tr><td colspan="5" style="text-align:center">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ–±–ª–∞–∫–∞...</td></tr>
                </tbody>
            </table>

            <h3>–î—Ä—É–≥–∏–µ –°—Ç–µ–Ω–¥—ã</h3>
            <div class="stands-grid">
                <div class="stand-card">
                    <h4>PROD</h4>
                    <div class="stand-offline">üö´ –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ (VPN required)</div>
                </div>
                <div class="stand-card">
                    <h4>M2</h4>
                    <div class="stand-offline">‚ö†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã</div>
                </div>
                <div class="stand-card">
                    <h4>M3</h4>
                    <div class="stand-offline">üîå –û—Ç–∫–ª—é—á–µ–Ω</div>
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ 3: –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
        <div id="page-stats" class="page">
            <h2>–ò—Å—Ç–æ—Ä–∏—è —Å–±–æ—Ä–æ–∫</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–û–±—Ä–∞–∑</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞</th>
                        <th>–õ–æ–≥–∏</th>
                    </tr>
                </thead>
                <tbody id="stats-rows">
                    <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                </tbody>
            </table>
        </div>

    </main>

    <!-- LOGS MODAL -->
    <div id="logsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>–õ–æ–≥–∏ –°–±–æ—Ä–∫–∏</h3>
            <div id="modal-logs-body">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // type: —Ç–µ–ø–µ—Ä—å —ç—Ç–æ –∏–º—è —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ (–±–µ–∑ .yaml)
        // iconType: –∫–ª—é—á –¥–ª—è –∏–∫–æ–Ω–∫–∏
        const distros = [
            { id: 'alma8',  name: 'AlmaLinux 8',         imageName: 'AlmaLinux-8', type: 'alma-8',    iconType: 'alma',    color: '#e0e0e0', disabled: true,  args: '' },
            { id: 'deb11',  name: 'Debian 11',           imageName: 'Debian-11',   type: 'debian-11', iconType: 'debian',  color: '#d70a53', disabled: false, args: '--pkg vim,curl' },
            { id: 'deb12',  name: 'Debian 12',           imageName: 'Debian-12',   type: 'debian-12', iconType: 'debian',  color: '#d70a53', disabled: false, args: '--pkg vim,curl' },
            { id: 'deb13',  name: 'Debian 13 (Trixie)',  imageName: 'Debian-13',   type: 'debian-13', iconType: 'debian',  color: '#d70a53', disabled: true,  args: '' },
            { id: 'rocky9', name: 'Rocky Linux 9',       imageName: 'Rocky-9',     type: 'rocky-9',   iconType: 'rocky',   color: '#10b981', disabled: true,  args: '' },
            { id: 'sysres', name: 'SysRescueCD',         imageName: 'SysRescue',   type: 'sysrescue', iconType: 'custom',  color: '#2196f3', disabled: true,  args: '' },
            { id: 'ubu22',  name: 'Ubuntu 22.04',        imageName: 'Ubuntu-22',   type: 'ubuntu-22', iconType: 'ubuntu',  color: '#e95420', disabled: true,  args: '' },
            { id: 'ubu24',  name: 'Ubuntu 24.04',        imageName: 'Ubuntu-24',   type: 'ubuntu-24', iconType: 'ubuntu',  color: '#e95420', disabled: false, args: '--minimal' },
            { id: 'win16',  name: 'Windows Server 2016', imageName: 'Windows-2016',type: 'win-2016',  iconType: 'windows', color: '#00a4ef', disabled: true,  args: '', eol: true },
            { id: 'win19',  name: 'Windows Server 2019', imageName: 'Windows-2019',type: 'win-2019',  iconType: 'windows', color: '#00a4ef', disabled: true,  args: '' },
            { id: 'win22',  name: 'Windows Server 2022', imageName: 'Windows-2022',type: 'win-2022',  iconType: 'windows', color: '#00a4ef', disabled: true,  args: '' },
        ];

        // --- ICONS (SVG Strings) ---
        const icons = {
            debian: '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>',
            ubuntu: '<circle cx="12" cy="12" r="10"/>',
            windows: '<path d="M3 12V6.5l8-1.1v6.6H3zm9 0v6.9l8 1.1V12h-8zm0-7.1l8-1.1V12h-8V4.9zm-9 7.6h8v6.4l-8-1.1V12.5z"/>',
            rocky: '<path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2-1-2-1-2 1 2 1zm0 2l-8-4v10l8 4 8-4V9l-8 4z"/>', // Generic cube
            alma: '<path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2-1-2-1-2 1 2 1zm0 2l-8-4v10l8 4 8-4V9l-8 4z"/>',
            custom: '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9v-2h2v2zm1-5c-2.5 0-4-1.5-4-3.5S10.5 4 13 4s4 1.5 4 3.5-2 3.5-3.5 3.5c-.5 0-1 .5-1 1V11h-2v-1c0-1.5 1.5-2 2-2z"/>'
        };

        // --- TABS LOGIC ---
        function showTab(tabName) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));

            document.getElementById('page-' + tabName).classList.add('active');
            
             const buttons = document.querySelectorAll('.nav-btn');
             if(tabName === 'images') buttons[0].classList.add('active');
             if(tabName === 'stands') {
                 buttons[1].classList.add('active');
                 loadStandsMock(); 
             }
             if(tabName === 'stats') {
                 buttons[2].classList.add('active');
                 fetchHistory(); 
             }
        }
        
        // --- RENDER TABLE ---
        function renderImagesTable() {
            const tbody = document.getElementById('images-table-body');
            tbody.innerHTML = '';

            distros.forEach(d => {
                const tr = document.createElement('tr');
                if (d.disabled) tr.className = 'disabled-row';
                
                // Icon selection
                const iconPath = icons[d.iconType] || icons.custom;
                const eolBadge = d.eol ? '<span class="badge badge-no">–î–∞</span>' : '<span class="badge badge-yes">–ù–µ—Ç</span>';
                
                // Unique IDs for dynamic updates
                const idUploaded = `uploaded-${d.id}`;
                const idTesting = `testing-${d.id}`; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç–æ—Ç ID –∫–∞–∫ –µ–¥–∏–Ω—ã–π —Å—Ç–∞—Ç—É—Å
                const idBtn = `btn-${d.id}`;

                // Action Button
                let actionBtn = '';
                if (d.disabled) {
                    actionBtn = '<button class="btn-action btn-disabled">üîí –°–∫–æ—Ä–æ</button>';
                } else {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º imageName –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ (–º—ã –µ–≥–æ –¥–æ–±–∞–≤–∏–ª–∏ —Ä–∞–Ω–µ–µ –∏–ª–∏ –¥–æ–±–∞–≤–∏–º —Å–µ–π—á–∞—Å)
                    // –ï—Å–ª–∏ imageName –Ω–µ—Ç, —Ñ–æ–ª–ª–±–µ–∫ –Ω–∞ name.replace
                    const safeName = d.imageName || d.name.replace(/\s+/g, '-');
                    
                    // –í–ê–ñ–ù–û: –ü–µ—Ä–µ–¥–∞–µ–º idTesting –∫–∞–∫ statusId
                    actionBtn = `<button id="${idBtn}" class="btn-action" onclick="startBuild('${safeName}', '${d.type}', '${idBtn}', '${idTesting}')">üöÄ –°–æ–±—Ä–∞—Ç—å</button>`;
                }

                tr.innerHTML = `
                    <td>
                        <span style="display:flex; align-items:center;">
                            <svg width="20" height="20" viewBox="0 0 24 24" style="margin-right:8px; fill:${d.color}">${iconPath}</svg> 
                            ${d.disabled ? d.name : `<strong>${d.name}</strong>`}
                        </span>
                    </td>
                    <td><span id="${idUploaded}" class="badge badge-no">–ù–µ—Ç</span></td>
                    <td><span id="${idTesting}" class="badge badge-unk">–ù–µ—Ç</span></td>
                    <td><input type="text" value="${d.args}" ${d.disabled ? 'disabled' : ''} style="width: 150px;"></td>
                    <td>${actionBtn}</td>
                    <td>${eolBadge}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- DASHBOARD UPDATER ---
        async function updateDashboard() {
            // 1. Check Uploaded Images (Glance)
            try {
                const res = await fetch('/api/images');
                if (res.ok) {
                    const images = await res.json();
                    distros.forEach(d => {
                        const safeName = d.imageName || d.name.replace(/\s+/g, '-');
                        const el = document.getElementById(`uploaded-${d.id}`);
                        if (el) {
                            // –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∏–º–µ–Ω–∏ (–∏–ª–∏ –º–æ–∂–Ω–æ startsWith)
                            // Glance –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç {name: "Ubuntu-24-04", ...}
                            // –£ –Ω–∞—Å safeName = "Ubuntu-24.04"
                            // –õ—É—á—à–µ —Å–¥–µ–ª–∞—Ç—å –≥–∏–±–∫–∏–π –ø–æ–∏—Å–∫.
                            const found = images.some(img => img.name === safeName || img.name.includes(safeName));
                            
                            if (found) {
                                el.className = "badge badge-yes";
                                el.innerText = "–î–∞";
                            } else {
                                el.className = "badge badge-no";
                                el.innerText = "–ù–µ—Ç";
                            }
                        }
                    });
                }
            } catch (e) { console.error("API Error (Images):", e); }

            // 2. Check Testing Status (Last Build)
            try {
                const res = await fetch('/api/history');
                if (res.ok) {
                    const history = await res.json();
                    // History –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ DESC (—Å–≤–µ–∂–∏–µ —Å–≤–µ—Ä—Ö—É)
                    
                    distros.forEach(d => {
                        const safeName = d.imageName || d.name.replace(/\s+/g, '-');
                        const el = document.getElementById(`testing-${d.id}`);
                        const btn = document.getElementById(`btn-${d.id}`);

                        // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, –∑–Ω–∞—á–∏—Ç –∏–¥–µ—Ç –∞–∫—Ç–∏–≤–Ω–∞—è —Å–±–æ—Ä–∫–∞.
                        // –ù–µ —Ç—Ä–æ–≥–∞–µ–º —Å—Ç–∞—Ç—É—Å, —á—Ç–æ–±—ã –Ω–µ —Å–±–∏—Ç—å –ø–æ–ª–ª–µ—Ä.
                        if (btn && btn.disabled) return;
                        
                        // –ò—â–µ–º –ø–µ—Ä–≤—É—é –ø–æ–ø–∞–≤—à—É—é—Å—è (—Å–∞–º—É—é —Å–≤–µ–∂—É—é) —Å–±–æ—Ä–∫—É —ç—Ç–æ–≥–æ –æ–±—Ä–∞–∑–∞
                        const lastBuild = history.find(b => b.image_name === safeName);
                        
                        if (el && lastBuild) {
                            if (lastBuild.status === 'SUCCESS') {
                                el.className = "badge badge-yes";
                                el.innerText = "–£—Å–ø–µ—à–Ω–æ";
                            } else if (lastBuild.status.startsWith('ERROR')) {
                                el.className = "badge badge-no";
                                el.innerText = "–û—à–∏–±–∫–∞";
                            } else {
                                // PENDING, BUILDING...
                                el.className = "badge badge-unk";
                                el.innerText = "–í –ø—Ä–æ—Ü–µ—Å—Å–µ";
                            }
                        } else if (el) {
                            el.className = "badge badge-unk";
                            el.innerText = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
                        }
                    });
                }
            } catch (e) { console.error("API Error (History):", e); }
        }

        // --- LOGGER & PROGRESS ---
        const logContainer = document.getElementById('log-container');
        const logsDiv = document.getElementById('live-logs');
        const progressBar = document.getElementById('progress-bar');

        function log(msg) {
            logContainer.style.display = 'block'; 
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            
            logsDiv.appendChild(div);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function setProgress(percent) {
            progressBar.style.width = percent + '%';
        }

        // --- BUILD LOGIC ---
        async function startBuild(name, distro, btnId, statusId) {
            const btn = document.getElementById(btnId);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –±–µ–π–¥–∂–∏–∫ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ "–¢–µ—Å—Ç..."
            if (statusId) {
                const badge = document.getElementById(statusId);
                badge.innerText = "–¢–µ—Å—Ç...";
                badge.className = "badge badge-unk";
            }

            // UI Reset
            btn.disabled = true;
            btn.innerText = "–ó–∞–ø—É—Å–∫..."; 
            btn.classList.add('btn-disabled');
            setProgress(0);
            logsDiv.innerHTML = ''; 
            
            log(`–ü—Ä–∏–≤–µ—Ç —Å–Ω–æ–≤–∞, –¥—Ä—É–≥! –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–±–æ—Ä–∫—É ${name}...`);

            try {
                const res = await fetch('/build', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_name: name, distro: distro })
                });

                if (!res.ok) {
                    if (res.status === 401) throw new Error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏! –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
                    throw new Error(await res.text());
                }

                const data = await res.json();
                log(`–°–±–æ—Ä–∫–∞ ID: ${data.build_id} –ø—Ä–∏–Ω—è—Ç–∞ —Å–µ—Ä–≤–µ—Ä–æ–º!`); 
                
                // –ü–µ—Ä–µ–¥–∞–µ–º statusId –≤ –ø–æ–ª–ª–µ—Ä
                pollBuildStatus(data.build_id, btn, statusId);

            } catch (e) {
                log(`–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: ${e.message}`); 
                alert(`–û—à–∏–±–∫–∞: ${e.message}`);
                btn.disabled = false;
                btn.innerText = "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä–∫—É"; 
                btn.classList.remove('btn-disabled');
            }
        }

        function pollBuildStatus(id, btn, statusId) {
            let errorCount = 0;
            const interval = setInterval(async () => {
                try {
                    const res = await fetch(`/api/build/${id}`);
                    if (!res.ok) throw new Error("Status check failed");
                    
                    const data = await res.json();
                    const status = data.status;
                    
                    updateProgressByStatus(status, btn, interval, statusId);

                } catch (e) {
                    errorCount++;
                    if (errorCount > 5) {
                        clearInterval(interval);
                        log("–ü–æ—Ç–µ—Ä—è–Ω–∞ —Å–≤—è–∑—å —Å —Å–µ—Ä–≤–µ—Ä–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π."); 
                        btn.disabled = false;
                    }
                }
            }, 3000); 
        }

        function updateProgressByStatus(status, btn, interval, statusId) {
            const progressBar = document.getElementById('progress-bar');
            let pct = 0;
            let msg = "";
            let finished = false;
            let isError = false;

            const badge = statusId ? document.getElementById(statusId) : null;

            switch (status) {
                case 'PENDING':
                    pct = 5; msg = "–∑–∞–≥—Ä—É–∑–∫–∞ –ø–∞–∫–µ—Ç–æ–≤, –æ–∫–æ–ª–æ —Ç—Ä–µ—Ö –º–∏–Ω—É—Ç";
                    break;
                case 'BUILDING':
                    pct = 30; msg = "–°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ (disk-image-builder)...";
                    break;
                case 'UPLOADING':
                    pct = 60; msg = "–ó–∞–≥—Ä—É–∑–∫–∞ –≤ OpenStack Glance...";
                    break;
                case 'BOOTING_VM':
                    pct = 80; msg = "–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π VM...";
                    break;
                case 'WAITING_AGENT':
                    pct = 90; msg = "–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –æ—Ç –ê–≥–µ–Ω—Ç–∞...";
                    break;
                case 'SUCCESS':
                    pct = 100; msg = "–°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!";
                    finished = true;
                    progressBar.style.backgroundColor = "var(--success)";
                    
                    if (badge) {
                        badge.innerText = "–£—Å–ø–µ—à–Ω–æ";
                        badge.className = "badge badge-yes";
                    }
                    break;
                case 'ERROR_TIMEOUT':
                     pct = 100; msg = "–ê–≥–µ–Ω—Ç –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Ä—É—á–Ω—É—é: /usr/local/bin/agent (–£–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 7 –º–∏–Ω)";
                     finished = true; // Stop polling? Or keep polling to see success? Let's stop for now as UI button resets.
                     isError = true;
                     progressBar.style.backgroundColor = "var(--danger)";
                     if (badge) {
                            badge.innerText = "Timeout";
                            badge.className = "badge badge-no";
                     }
                     break;
                default:
                    if (status.startsWith("ERROR")) {
                        pct = 100; msg = `–û—à–∏–±–∫–∞: ${status}`;
                        finished = true;
                        isError = true;
                        progressBar.style.backgroundColor = "var(--danger)";
                        
                        if (badge) {
                            badge.innerText = "–û—à–∏–±–∫–∞";
                            badge.className = "badge badge-no";
                        }
                    } else {
                        pct = 10; msg = `–°—Ç–∞—Ç—É—Å: ${status}`;
                    }
            }

            setProgress(pct);
            
            const logsDiv = document.getElementById('live-logs');
            if (!logsDiv.lastChild || !logsDiv.lastChild.innerText.includes(msg)) {
                 log(msg);
            }

            if (finished) {
                clearInterval(interval);
                btn.disabled = false;
                btn.classList.remove('btn-disabled');
                btn.innerText = isError ? "–û—à–∏–±–∫–∞ (–ü–æ–≤—Ç–æ—Ä–∏—Ç—å)" : "–ì–æ—Ç–æ–≤–æ (–ï—â–µ —Ä–∞–∑)";
                // Refresh dashboard immediately
                updateDashboard();
            }
        }

        // --- HISTORY & LOGS ---
        async function fetchHistory() {
            const tbody = document.getElementById('stats-rows');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';

            try {
                const res = await fetch('/api/history');
                const data = await res.json();
                
                tbody.innerHTML = '';
                if (!data || data.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</td></tr>';
                     return;
                }

                data.forEach(b => {
                    const tr = document.createElement('tr');
                    let badgeClass = 'badge-unk';
                    if (b.status === 'SUCCESS') badgeClass = 'badge-yes';
                    if (b.status.startsWith('ERROR')) badgeClass = 'badge-no';

                    tr.innerHTML = `
                        <td>#${b.id}</td>
                        <td>${b.image_name}</td>
                        <td><span class="badge ${badgeClass}">${b.status}</span></td>
                        <td>${new Date(b.created_at).toLocaleString()}</td>
                        <td><a href="#" onclick="showLogs(${b.id}); return false;" style="color: var(--accent)">–ü–æ–∫–∞–∑–∞—Ç—å</a></td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red">–û—à–∏–±–∫–∞: ${e.message}</td></tr>`;
            }
        }

        async function showLogs(id) {
            document.getElementById('logsModal').style.display = "block";
            const body = document.getElementById('modal-logs-body');
            body.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞...";
            
            try {
                const res = await fetch(`/api/build/${id}`);
                const data = await res.json();
                body.innerText = data.logs || "[–õ–æ–≥–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç]";
            } catch (e) {
                body.innerText = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏: " + e.message;
            }
        }

        function closeModal() {
            document.getElementById('logsModal').style.display = "none";
        }
        
        window.onclick = function(event) {
            const modal = document.getElementById('logsModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // --- STANDS API ---
        async function loadStandsMock() {
            const tbody = document.getElementById('stand-devstack-rows');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ–±–ª–∞–∫–∞...</td></tr>';
            
            try {
                const res = await fetch('/api/images');
                if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ API");
                
                const data = await res.json();
                tbody.innerHTML = ''; 

                if (!data || data.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">–ù–µ—Ç –æ–±—Ä–∞–∑–æ–≤</td></tr>';
                     return;
                }

                data.forEach(img => {
                    const tr = document.createElement('tr');
                    const badgeClass = img.status === 'active' ? 'badge-yes' : 'badge-unk';
                    
                    tr.innerHTML = `
                        <td><code title="${img.id}">${img.id}</code></td>
                        <td>${img.name}</td>
                        <td><span class="badge ${badgeClass}">${img.status}</span></td>
                        <td>${img.created_at}</td>
                        <td>${formatBytes(img.size)}</td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: #f44336">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫: ${e.message}</td></tr>`;
            }
        }

        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderImagesTable();
            updateDashboard();
            setInterval(updateDashboard, 15000); // Auto-refresh every 15s
        });

    </script>
</body>
</html>