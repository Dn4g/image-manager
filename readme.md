**Image Manager** ‚Äî —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –æ–±–ª–∞—á–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤ (Cloud Images) –¥–ª—è OpenStack.
–û–Ω —Å–æ–±–∏—Ä–∞–µ—Ç –æ–±—Ä–∞–∑ –û–° —Å –Ω—É–ª—è, –∑–∞–≥—Ä—É–∂–∞–µ—Ç –µ–≥–æ –≤ –æ–±–ª–∞–∫–æ, —Å–æ–∑–¥–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—É—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –µ—ë —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∏ —É–±–∏—Ä–∞–µ—Ç –∑–∞ —Å–æ–±–æ–π.

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

*   **–°–±–æ—Ä–∫–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `disk-image-builder` (DIB) –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤ (Debian, Ubuntu –∏ –¥—Ä.).
*   **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è:** –ü–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω: Build -> Upload (Glance) -> Boot (Nova) -> Test -> Cleanup.
*   **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í–Ω–µ–¥—Ä—è–µ—Ç **gRPC –ê–≥–µ–Ω—Ç–∞** –≤–Ω—É—Ç—Ä—å –æ–±—Ä–∞–∑–∞, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–ø–æ—Ä—Ç—É–µ—Ç –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–µ—Ç–∏ –∏ –¥–∏—Å–∫–æ–≤.
*   **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ SSH-–∫–ª—é—á–µ–π –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
*   **Web UI:** –ü—Ä–æ—Å—Ç–æ–π –¥–∞—à–±–æ—Ä–¥ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–±–æ—Ä–æ–∫.

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```text
image-manager/
‚îú‚îÄ‚îÄ cmd/
‚îÇ   ‚îú‚îÄ‚îÄ image-manager/      # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ —Å–µ—Ä–≤–µ—Ä–∞ (Manager)
‚îÇ   ‚îî‚îÄ‚îÄ agent/              # –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –ê–≥–µ–Ω—Ç–∞ (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ VM)
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ adapter/openstack/  # –ö–ª–∏–µ–Ω—Ç Gophercloud (Nova, Glance)
‚îÇ   ‚îú‚îÄ‚îÄ config/             # –ß—Ç–µ–Ω–∏–µ ENV –∏ –∫–æ–Ω—Ñ–∏–≥–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ handler/            # HTTP API –∏ Web UI –ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ logger/             # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ slog (JSON/Text)
‚îÇ   ‚îú‚îÄ‚îÄ server/grpc/        # gRPC-—Å–µ—Ä–≤–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ service/            # –û–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ DIB
‚îÇ   ‚îî‚îÄ‚îÄ storage/            # –†–∞–±–æ—Ç–∞ —Å SQLite (–∏—Å—Ç–æ—Ä–∏—è —Å–±–æ—Ä–æ–∫)
‚îú‚îÄ‚îÄ pkg/
‚îÇ   ‚îî‚îÄ‚îÄ pb/                 # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π gRPC –∫–æ–¥ (Protobuf)
‚îú‚îÄ‚îÄ elements/               # –ö–∞—Å—Ç–æ–º–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã disk-image-builder
‚îÇ   ‚îú‚îÄ‚îÄ agent-install/      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∏–Ω–∞—Ä–Ω–∏–∫–∞ –∞–≥–µ–Ω—Ç–∞ –∏ systemd —Å–µ—Ä–≤–∏—Å–∞
‚îÇ   ‚îî‚îÄ‚îÄ cloud-init-custom/  # –•–∞—Ä–¥–∫–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–∫ SSH (PasswordAuth)
‚îú‚îÄ‚îÄ web/                    # –°—Ç–∞—Ç–∏–∫–∞ (index.html)
‚îî‚îÄ‚îÄ config.env.example      # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```

---

## üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –ó–∞–ø—É—Å–∫

### 1. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
*   Linux (Ubuntu/Debian)
*   Go 1.21+
*   `disk-image-builder` (`pip install diskimage-builder`)
*   `qemu-utils`
*   –î–æ—Å—Ç—É–ø –∫ OpenStack

### 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ê–≥–µ–Ω—Ç–∞
–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å –∞–≥–µ–Ω—Ç–∞ –∏ –ø–æ–ª–æ–∂–∏—Ç—å –µ–≥–æ –≤ —ç–ª–µ–º–µ–Ω—Ç DIB:

```bash
# –ö–æ–º–ø–∏–ª—è—Ü–∏—è –ø–æ–¥ Linux AMD64
GOOS=linux GOARCH=amd64 go build -o elements/agent-install/agent cmd/agent/main.go
```

### 3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `config.env` –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–º–µ—Ä–∞:

```bash
cp config.env.example config.env
# –†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã OpenStack (Auth URL, Password, Project ID)
```

### 4. –ó–∞–ø—É—Å–∫ –ú–µ–Ω–µ–¥–∂–µ—Ä–∞

```bash
# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ —Å—Ç–∞—Ä—Ç
source config.env
go run cmd/image-manager/main.go
```

–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: `http://localhost:8080`

---

## üîç –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (Workflow)

1.  **POST /build:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É –≤ UI.
2.  **DB:** –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –æ —Å–±–æ—Ä–∫–µ (`PENDING`).
3.  **DIB:** –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å —Å–±–æ—Ä–∫–∏ `.qcow2` —Ñ–∞–π–ª–∞. –í –æ–±—Ä–∞–∑ –≤–Ω–µ–¥—Ä—è–µ—Ç—Å—è:
    *   `cloud-init` –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ç–∏.
    *   `qemu-guest-agent`.
    *   –ë–∏–Ω–∞—Ä–Ω–∏–∫ `agent` –∏ systemd-—é–Ω–∏—Ç –¥–ª—è –µ–≥–æ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞.
4.  **Glance:** –û–±—Ä–∞–∑ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ OpenStack.
5.  **Nova:** –°–æ–∑–¥–∞–µ—Ç—Å—è VM –∏–∑ —ç—Ç–æ–≥–æ –æ–±—Ä–∞–∑–∞ (—Å SSH-–∫–ª—é—á–æ–º –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞).
6.  **Agent:** VM –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –∞–≥–µ–Ω—Ç —Å—Ç–∞—Ä—Ç—É–µ—Ç –∏ –∑–≤–æ–Ω–∏—Ç –Ω–∞ gRPC –ø–æ—Ä—Ç –ú–µ–Ω–µ–¥–∂–µ—Ä–∞ (`:50051`).
    *   –ê–≥–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–∏—Å–∫ –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.
    *   –ê–≥–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á–µ—Ç (`SUCCESS/FAIL`).
    *   –ê–≥–µ–Ω—Ç —Å–∞–º–æ—É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç—Å—è.
7.  **Cleanup:** –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç—á–µ—Ç, —É–¥–∞–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤—É—é VM –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤ –ë–î.

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

*   **–õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:** –ü–∏—à—É—Ç—Å—è –≤ `stdout` –∏ —Ñ–∞–π–ª `app.log`.
*   **–õ–æ–≥–∏ —Å–±–æ—Ä–∫–∏:** –í–∏–¥–Ω—ã –≤ –ª–æ–≥–µ —Å–µ—Ä–≤–µ—Ä–∞ (–ø—Ä–µ—Ñ–∏–∫—Å `[DIB]`).
*   **VM –Ω–µ –∑–≤–æ–Ω–∏—Ç?**
    *   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Security Groups (—Ä–∞–∑—Ä–µ—à–µ–Ω –ª–∏ –∏—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫ –Ω–∞ –ø–æ—Ä—Ç 50051).
    *   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `config.env`: –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —É–∫–∞–∑–∞–Ω IP –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–ª—è –∞–≥–µ–Ω—Ç–∞.
